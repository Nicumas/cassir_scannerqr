<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</title>
  
  <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ -->
  <script src="https://telegram.org/js/telegram-web-app.js "></script>
  <script src="https://unpkg.com/html5-qrcode @2.3.7/html5-qrcode.min.js"></script>
  
  <style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
    }

    #videoContainer {
      position: relative;
      width: 100%;
      height: 100vh; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º vh –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #scanner-container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ */
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      text-align: center;
      padding: 20px 0;
      background: rgba(0,0,0,0.7);
    }

    #msg {
      font-size: 1.2em;
      padding: 10px;
    }

    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 1.2em;
      background: #31a952;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    #error {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #ff4444;
      font-weight: bold;
      z-index: 30;
      display: none;
      padding: 10px;
      background: rgba(0,0,0,0.7);
    }

    .hidden {
      display: none !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–∫–∞–Ω–µ—Ä–∞ */
    .html5-qrcode-element {
      width: 100%!important;
      height: 100%!important;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div id="videoContainer">
    <button id="startButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    <div id="scanner-container" class="hidden"></div>
    <div id="overlay" class="hidden">
      <div id="msg">üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</div>
    </div>
    <div id="error"></div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const startButton = document.getElementById('startButton');
    const msg = document.getElementById('msg');
    const overlay = document.getElementById('overlay');
    const errorEl = document.getElementById('error');
    const scannerContainer = document.getElementById('scanner-container');
    
    let html5QrCode = null;
    let scanning = false;

    // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
    function showError(message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      console.error(message);
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    function stopScanner() {
      if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
          scanning = false;
          html5QrCode = null;
          scannerContainer.innerHTML = '';
        }).catch(err => {
          console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
        });
      }
    }

    // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞
    async function startScanner() {
      if (scanning) return;
      
      try {
        startButton.classList.add('hidden');
        scannerContainer.classList.remove('hidden');
        overlay.classList.remove('hidden');
        errorEl.style.display = 'none';
        
        html5QrCode = new Html5Qrcode("scanner-container");
        
        const config = {
          fps: 10,
          qrbox: 200
        };
        
        scanning = true;
        
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          qrCodeMessage => {
            handleScannedCode(qrCodeMessage);
          },
          () => {
            msg.textContent = "üîç –°–∫–∞–Ω–∏—Ä—É—é...";
          }
        );
        
      } catch (err) {
        scanning = false;
        startButton.classList.remove('hidden');
        scannerContainer.classList.add('hidden');
        overlay.classList.add('hidden');
        
        let errorMessage = 'üö´ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
        
        if (err.name === 'NotAllowedError') {
          errorMessage = '‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
        } else if (err.name === 'NotFoundError') {
          errorMessage = '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
        } else if (err.name === 'OverconstrainedError') {
          tryFrontCamera();
          return;
        } else if (err.message?.includes('video constraints')) {
          errorMessage = '‚ùå –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã';
        } else {
          errorMessage = '‚ùå –û—à–∏–±–∫–∞: ' + (err.message || err);
        }
        
        showError(errorMessage);
        console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
      }
    }

    // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É
    async function tryFrontCamera() {
      try {
        scannerContainer.innerHTML = '';
        html5QrCode = new Html5Qrcode("scanner-container");
        
        const config = {
          fps: 10,
          qrbox: 200
        };
        
        scanning = true;
        
        await html5QrCode.start(
          { facingMode: "user" },
          config,
          qrCodeMessage => {
            handleScannedCode(qrCodeMessage);
          },
          () => {
            msg.textContent = "üîç –°–∫–∞–Ω–∏—Ä—É—é...";
          }
        );
        
      } catch (err) {
        scanning = false;
        startButton.classList.remove('hidden');
        scannerContainer.classList.add('hidden');
        overlay.classList.add('hidden');
        showError('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ QR-–∫–æ–¥–∞
    function handleScannedCode(data) {
      try {
        const payload = JSON.parse(data);
        if (payload.type === "client" && payload.uid) {
          msg.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω –∫–ª–∏–µ–Ω—Ç: UID ${payload.uid}`;
          
          if (window.Telegram?.WebApp) {
            Telegram.WebApp.sendData(JSON.stringify(payload));
          }
          
          stopScanner();
        } else {
          msg.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥';
          setTimeout(() => {
            msg.textContent = 'üîç –°–∫–∞–Ω–∏—Ä—É—é...';
          }, 2000);
        }
      } catch (e) {
        msg.textContent = '‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö QR';
        setTimeout(() => {
          msg.textContent = 'üîç –°–∫–∞–Ω–∏—Ä—É—é...';
        }, 2000);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('DOMContentLoaded', () => {
      if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
        startScanner();
      } else {
        startButton.classList.remove('hidden');
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    startButton.addEventListener('click', startScanner);

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      stopScanner();
    });
  </script>
</body>
</html>
