<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body {
      margin: 0; display: flex;
      flex-direction: column; align-items: center; justify-content: center;
      background: #000; color: white; font-family: sans-serif;
    }
    video {
      width: 100vw; height: auto;
    }
    #msg {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline></video>
  <div id="msg">üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR</div>

  <script>
    const video = document.getElementById('video');
    const msg = document.getElementById('msg');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        requestAnimationFrame(scanFrame);
      } catch (err) {
        msg.textContent = 'üö´ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ.';
      }
    }

    function scanFrame() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = context.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imgData.data, canvas.width, canvas.height);

        if (code) {
          try {
            const payload = JSON.parse(code.data);
            if (payload.type === "client" && payload.uid) {
              Telegram.WebApp.sendData(JSON.stringify(payload));
              msg.textContent = "‚úÖ –ù–∞–π–¥–µ–Ω: UID " + payload.uid;
              return;
            } else {
              msg.textContent = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR.";
            }
          } catch (e) {
            msg.textContent = "‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è QR.";
          }
        }
      }
      requestAnimationFrame(scanFrame);
    }

    window.addEventListener("load", () => {
      Telegram.WebApp.ready();
      startCamera();
    });
  </script>
</body>
</html>
