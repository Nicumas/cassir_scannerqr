<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/html5-qrcode.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      position: fixed;
    }
    #videoContainer {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    #scanner-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 10;
      text-align: center;
      padding: 20px 0;
      background: rgba(0,0,0,0.7);
    }
    #msg {
      font-size: 1.2em;
      padding: 10px;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 1.2em;
      background: #31a952;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      z-index: 20;
      box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    #error {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      color: #ff4444;
      font-weight: bold;
      z-index: 30;
      display: none;
      padding: 10px;
      background: rgba(0,0,0,0.7);
    }
    .hidden {
      display: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–∫–∞–Ω–µ—Ä–∞ */
    .html5-qrcode-element {
      width: 100%!important;
      height: 100%!important;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div id="videoContainer">
    <button id="startButton">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä</button>
    <div id="scanner-container" class="hidden"></div>
    <div id="overlay" class="hidden">
      <div id="msg">üì∑ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥</div>
    </div>
    <div id="error"></div>
  </div>

  <script>
    const startButton = document.getElementById('startButton');
    const msg = document.getElementById('msg');
    const overlay = document.getElementById('overlay');
    const errorEl = document.getElementById('error');
    const scannerContainer = document.getElementById('scanner-container');
    
    let html5QrCode = null;
    let scanning = false;

    // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
    function showError(message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      console.error(message);
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    function stopScanner() {
      if (html5QrCode && scanning) {
        html5QrCode.stop().then(() => {
          scanning = false;
          html5QrCode = null;
          scannerContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        }).catch(err => {
          console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞:", err);
        });
      }
    }

    // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏
    async function startScanner() {
      if (scanning) return;
      
      try {
        startButton.classList.add('hidden');
        scannerContainer.classList.remove('hidden');
        overlay.classList.remove('hidden');
        errorEl.style.display = 'none';
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞
        html5QrCode = new Html5Qrcode("scanner-container");
        
        // –£–ü–†–û–©–ï–ù–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–ï–ó –õ–ò–®–ù–ò–• –ü–ê–†–ê–ú–ï–¢–†–û–í
        const config = {
          fps: 10,
          qrbox: 200
        };
        
        scanning = true;
        
        // –ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ú–ò –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú–ò
        await html5QrCode.start(
          { facingMode: "environment" },
          config,
          qrCodeMessage => {
            handleScannedCode(qrCodeMessage);
          },
          () => {
            msg.textContent = "üîç –°–∫–∞–Ω–∏—Ä—É—é...";
          }
        ).catch(err => {
          throw err;
        });
        
      } catch (err) {
        scanning = false;
        startButton.classList.remove('hidden');
        scannerContainer.classList.add('hidden');
        overlay.classList.add('hidden');
        
        let errorMessage = 'üö´ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ';
        if (err.name === 'NotAllowedError') {
          errorMessage = '‚ùå –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
        } else if (err.name === 'NotFoundError') {
          errorMessage = '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
        } else if (err.name === 'OverconstrainedError') {
          // –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä–æ–π –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
          tryFrontCamera();
          return;
        } else if (err.message && err.message.includes('video constraints')) {
          errorMessage = '‚ùå –í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã';
        } else {
          errorMessage = '‚ùå –û—à–∏–±–∫–∞: ' + (err.message || err);
        }
        
        showError(errorMessage);
        console.error("Camera error details:", err);
      }
    }

    // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É
    async function tryFrontCamera() {
      try {
        scannerContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        html5QrCode = new Html5Qrcode("scanner-container");
        
        const config = {
          fps: 10,
          qrbox: 200
        };
        
        scanning = true;
        
        await html5QrCode.start(
          { facingMode: "user" }, // –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
          config,
          qrCodeMessage => {
            handleScannedCode(qrCodeMessage);
          },
          () => {
            msg.textContent = "üîç –°–∫–∞–Ω–∏—Ä—É—é...";
          }
        );
        
      } catch (err) {
        scanning = false;
        startButton.classList.remove('hidden');
        scannerContainer.classList.add('hidden');
        overlay.classList.add('hidden');
        showError('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∏ –æ–¥–Ω—É –∫–∞–º–µ—Ä—É');
      }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ QR-–∫–æ–¥–∞
    function handleScannedCode(data) {
      try {
        const payload = JSON.parse(data);
        if (payload.type === "client" && payload.uid) {
          msg.textContent = `‚úÖ –ù–∞–π–¥–µ–Ω –∫–ª–∏–µ–Ω—Ç: UID ${payload.uid}`;
          
          // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Telegram
          if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.sendData(JSON.stringify(payload));
          }
          
          // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—Ö–∞
          stopScanner();
        } else {
          msg.textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π QR-–∫–æ–¥';
          setTimeout(() => {
            msg.textContent = 'üîç –°–∫–∞–Ω–∏—Ä—É—é...';
          }, 2000);
        }
      } catch (e) {
        msg.textContent = '‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö QR';
        setTimeout(() => {
          msg.textContent = 'üîç –°–∫–∞–Ω–∏—Ä—É—é...';
        }, 2000);
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('DOMContentLoaded', () => {
      // –î–ª—è Telegram WebApp –∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        startScanner();
      } else {
        startButton.classList.remove('hidden');
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    startButton.addEventListener('click', startScanner);

    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
    window.addEventListener('beforeunload', () => {
      stopScanner();
    });
  </script>
</body>
</html>
